<!doctype html>
<meta charset="utf-8" />
<title>Yer browser seems a lil Rusty</title>
<link rel="stylesheet" href="" />
<body>
  <input id='reg' type = 'text' style='font-family: monospace'>
  <input id='target' type = 'text' style='font-family: monospace'>
  <div id='result' />
  <script type='module'>
    import { instantiate } from "./site.js"

    fetch("site.wasm")
      .then(resp => resp.arrayBuffer())

      .then(wasm => instantiate(wasm))

      .then(({ CompiledRegex }) => {
        var raw_reg = null

        // Will be caching the compiled regular expression between
        // changes. Needs to respond to the `free` function.
        var compiled_reg = {
          free: function() {},
        }

        const updateResult = function() {
          const reg = document.getElementById('reg').value || ''
          const target = document.getElementById('target').value || ''
          const result = document.getElementById('result')

          if (raw_reg !== reg) {
            compiled_reg.free()
            compiled_reg = CompiledRegex.new(reg)
            raw_reg = reg
          }

          result.innerHTML = compiled_reg.is_valid() ? `
            <span style='font-family: monospace'>/${reg}/</span> ${
              compiled_reg.is_match(target) ? 'matches' : 'does not match'
            } <span style='font-family: monospace'>"${target}"</span>
          ` : `
            <span style='font-family: monospace; color: salmon'>${compiled_reg.error_message()}</span>
          `
        }

        document.getElementById('reg').onkeyup = updateResult
        document.getElementById('target').onkeyup = updateResult
        updateResult()
      })
  </script>
</body>
