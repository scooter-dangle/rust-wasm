<!doctype html>
<meta charset="utf-8" />
<title>Yer browser seems a lil Rusty</title>
<link rel="stylesheet" href="" />
<input id='reg' type = 'text' style='font-family: monospace'>
<input id='target' type = 'text' style='font-family: monospace'>
<div id='result' />
<script type='text/javascript'>
  window.Module = {
    wasmBinaryFile: 'site.wasm',
    onRuntimeInitialized: () => {
      // Wrap exported functions
      const cwrappings = {
        regex_compare:   ['regex_compare',   'bool',   ['number', 'string']],
        regex_compile:   ['regex_compile',   'number', ['string']],
        regex_is_ok:     ['regex_is_ok',     'bool',   ['number']],
        regex_get_regex: ['regex_get_regex', 'number', ['number']],
        regex_get_err:   ['regex_get_err',   'string', ['number']],
        free_regex:      ['free_regex',      null,     ['number']],
      }

      var lib = {}

      for (var fn in cwrappings) {
        lib[fn] = window.Module.cwrap(...cwrappings[fn])
      }

      const RustRegex = function(regex_string) {
        const result = lib.regex_compile(regex_string)
        const is_valid = lib.regex_is_ok(result)

        if (is_valid) {
          const reg = lib.regex_get_regex(result)

          return {
            regex: function() { return regex_string },
            compare: function(string) {
              return lib.regex_compare(reg, string)
            },
            destroy: function() {
              lib.free_regex(reg)
            },
            err: function() { return null },
          }
        } else {
          const err = lib.regex_get_err(result)

          return {
            regex: function() { return regex_string },
            compare: function() { return null },
            destroy: function() {},
            err: function() { return err },
          }
        }
      }

      var rust_regex = {
        regex: function() {},
        destroy: function() {},
      }

      // Use exported functions
      const updateResult = function() {
        const reg = document.getElementById('reg').value || ''
        const target = document.getElementById('target').value || ''
        const result = document.getElementById('result')

        if (reg !== rust_regex.regex()) {
          rust_regex.destroy()
          rust_regex = RustRegex(reg)
        }

        result.innerHTML = rust_regex.err() ? `
          <span style='font-family: monospace; color: salmon'>${rust_regex.err()}</span>
        ` : `
          <span style='font-family: monospace'>/${reg}/</span> ${
            rust_regex.compare(target) ? 'matches' : 'does not match'
          } <span style='font-family: monospace'>"${target}"</span>
        `
      }

      document.getElementById('reg').onkeyup = updateResult
      document.getElementById('target').onkeyup = updateResult
      updateResult()
    },
  }

</script>
<script src='site.js'></script>
